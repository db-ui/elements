---
name: 💬 Add url for gh-page as issue comment to PR

on:
  workflow_call:
    inputs:
      release:
        required: false
        default: 'false'
        type: string
      preRelease:
        required: false
        default: 'false'
        type: string
      pr_number:
        required: true
        type: string
      owner:
        required: true
        type: string
      repo:
        required: true
        type: string
jobs:
  url:
    name: 💬 Add url for gh-page as issue comment to PR
    runs-on: ubuntu-latest
    steps:
      - name: ⬇ Checkout repo
        uses: actions/checkout@v3

      - name: ↔ Extract branch/tag name
        shell: bash
        env:
          RELEASE: ${{ inputs.release }}
          PRE_RELEASE: ${{ inputs.preRelease }}
        run: |
          if [[ $RELEASE == "true" || $PRE_RELEASE == "true" ]]
          then
            echo "##[set-output name=name;]$(echo ${GITHUB_REF#refs/tags/})"
          else
            echo "##[set-output name=name;]$(echo ${GITHUB_REF#refs/heads/})"
          fi
        id: extract

      - name: 📡 Get gh-pages url
        id: url
        env:
          RELEASE: ${{ inputs.release }}
          PRE_RELEASE: ${{ inputs.preRelease }}
          NAME: ${{ steps.extract.outputs.name }}
        run: |
          chmod +rx ./.github/scripts/get-gh-page-url.sh
          $URL=$(./.github/scripts/get-gh-page-url.sh)
          echo '::set-output name=url::$URL'

      - name: 📡 Add comment
        uses: actions/github-script@v6
        env:
          URL: ${{ steps.url.outputs.url }}
          PR_NUMBER: ${{ inputs.pr_number }}
          OWNER: ${{ inputs.owner }}
          REPO: ${{ inputs.repo }}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: PR_NUMBER,
              owner: $OWNER,
              repo: $REPO,
              body: '🔭🐙🐈 Test this branch here: $URL'
            })

      - name: 💀 Killing me softly
        uses: ./.github/actions/cancel-workflow
        if: failure()
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
